name: EC2 deploy (artifact-based, clean)

on:
  push:
    branches: [main, master]
    paths:
      - hello-ecr/**
      - .github/workflows/deploy-cf.yml
  workflow_dispatch:

concurrency:
  group: ec2-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_PORT: "5000"
  HEALTH_PATH: "/"
  AWS_REGION: eu-west-1
  EC2_INSTANCE_NAME: gha-terraform-runner
  EC2_INSTANCE_TYPE: t3.micro

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('hello-ecr/requirements.txt') }}

      - name: Build artifact
        run: |
          mkdir -p dist
          tar -czf dist/hello-ecr.tgz -C hello-ecr .
          (cd dist && sha256sum hello-ecr.tgz > hello-ecr.tgz.sha256)

      - uses: actions/upload-artifact@v4
        with:
          name: hello-ecr-artifact
          path: dist/
          compression-level: 0

  ensure_ec2:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      PUBLIC_IP: ${{ steps.out.outputs.PUBLIC_IP }}
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }} # optional
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure EC2 via CloudFormation (simple)
        id: ensure
        env:
          AWS_REGION:   ${{ env.AWS_REGION }}
          STACK_NAME:   ${{ env.EC2_INSTANCE_NAME }}
          KEY_NAME:     ${{ secrets.EC2_KEY_PAIR_NAME }}  # existing key pair name
          INSTANCE_TYPE: ${{ env.EC2_INSTANCE_TYPE }}
          APP_PORT:     ${{ env.APP_PORT }}
          YOUR_IP_CIDR: ${{ secrets.YOUR_IP_CIDR }}       # optional x.x.x.x/32
        run: bash hello-ecr/scripts/run_cfn_min.sh

      - name: Save outputs
        id: out
        run: |
          echo "PUBLIC_IP=${{ steps.ensure.outputs.PUBLIC_IP }}" >> $GITHUB_OUTPUT

  deploy:
    needs: [ build, ensure_ec2 ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with: { name: hello-ecr-artifact, path: ./artifact }

      - name: Verify artifact
        run: cd artifact && sha256sum -c hello-ecr.tgz.sha256

      - name: Prepare SSH key
        run: |
          mkdir -p ./ssh
          echo "${{ secrets.EC2_PRIVATE_KEY_PEM }}" > ./ssh/key.pem
          chmod 600 ./ssh/key.pem

      - name: SSH bootstrap
        run: |
          mkdir -p ~/.ssh && touch ~/.ssh/known_hosts
          ssh-keyscan -H ${{ needs.ensure_ec2.outputs.PUBLIC_IP }} >> ~/.ssh/known_hosts
          for i in {1..30}; do
            nc -z ${{ needs.ensure_ec2.outputs.PUBLIC_IP }} 22 && break || (echo "waiting for ssh..." && sleep 5)
          done

      - name: Upload & deploy
        env:
          HOST: ${{ needs.ensure_ec2.outputs.PUBLIC_IP }}
          APP_PORT: ${{ env.APP_PORT }}
          # If your app entrypoint isn't app:app, set APP_MODULE here, e.g. hello.main:app
          APP_MODULE: app:app
        run: |
          scp -i ./ssh/key.pem ./artifact/hello-ecr.tgz ec2-user@$HOST:/home/ec2-user/hello-ecr.tgz
          scp -i ./ssh/key.pem hello-ecr/scripts/deploy_systemd.sh ec2-user@$HOST:/home/ec2-user/deploy_systemd.sh
          ssh -i ./ssh/key.pem ec2-user@$HOST "APP_PORT=$APP_PORT APP_MODULE=$APP_MODULE bash /home/ec2-user/deploy_systemd.sh"

  cleanup:
    if: always()
    needs: [ ensure_ec2, deploy ]
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }} # optional
          aws-region: ${{ env.AWS_REGION }}

      # Optional teardown. Remove this step if you want the instance to persist.
      - name: Delete CloudFormation stack
        run: |
          aws cloudformation delete-stack \
            --stack-name "${{ env.EC2_INSTANCE_NAME }}" \
            --region "${{ env.AWS_REGION }}"
